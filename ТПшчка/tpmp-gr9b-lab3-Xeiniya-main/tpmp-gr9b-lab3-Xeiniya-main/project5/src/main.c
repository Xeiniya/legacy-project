#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "database.h"

/**
 * Отображает меню программы
 * Функция печатает все доступные опции для пользователя
 */
void display_menu() {
    printf("\n===== МЕНЮ УПРАВЛЕНИЯ БАЗОЙ ДАННЫХ АВТОВЛАДЕЛЬЦЕВ =====\n");
    printf("1. Вставка данных (autocommit)\n");    // Вставка с автоматическим коммитом
    printf("2. Вставка данных (транзакция)\n");    // Вставка с использованием транзакции
    printf("3. Поиск по ID\n");                    // Поиск владельца по ID
    printf("4. Поиск по фамилии (шаблон)\n");      // Поиск по шаблону фамилии
    printf("5. Поиск по городу\n");                // Поиск по городу
    printf("6. Удалить запись по ID\n");           // Удаление записи
    printf("7. Сохранить фото владельца в файл\n"); // Сохранение фото из БД в файл
    printf("8. Добавить владельца с фото\n");      // Добавление нового владельца с фото
    printf("0. Выход\n");                          // Выход из программы
    printf("Выберите действие: ");
}

/**
 * Главная функция программы
 * Обрабатывает пользовательский ввод и выполняет соответствующие операции с базой данных
 */
int main() {
    // Объявляем указатель на базу данных
    sqlite3 *db;
    
    // Пытаемся установить соединение с базой данных
    if (connect_db(&db)) {
        printf("Ошибка подключения к базе данных.\n");
        return 1;
    }

    printf("Успешное подключение к базе данных.\n");

    // Переменные для хранения выбора пользователя и входных данных
    int choice, id;
    char input[100];
    
    // Создаем директории для данных, если их нет
    // Используется для сохранения фотографий и других выходных данных
    system("mkdir -p data");
    
    // Основной цикл программы
    while (1) {
        // Отображаем меню и получаем выбор пользователя
        display_menu();
        scanf("%d", &choice);
        getchar(); // Очищаем символ новой строки после ввода
        
        // Обрабатываем выбор пользователя
        switch (choice) {
            case 1: // Вставка данных (autocommit)
                printf("\n--- Вставка данных (autocommit) ---\n");
                insert_autocommit(db);
                break;
                
            case 2: // Вставка данных (транзакция)
                printf("\n--- Вставка данных (транзакция) ---\n");
                insert_transaction(db);
                break;
                
            case 3: // Поиск по ID
                printf("\n--- Поиск владельца по ID ---\n");
                printf("Введите ID: ");
                scanf("%d", &id);
                getchar(); // Очищаем символ новой строки
                select_by_id(db, id);
                break;
                
            case 4: // Поиск по фамилии (шаблон)
                printf("\n--- Поиск владельца по фамилии ---\n");
                printf("Введите фрагмент фамилии: ");
                scanf("%s", input);
                getchar(); // Очищаем символ новой строки
                select_by_lastname_pattern(db, input);
                break;
                
            case 5: // Поиск по городу
                printf("\n--- Поиск владельцев по городу ---\n");
                printf("Введите название города: ");
                scanf("%s", input);
                getchar(); // Очищаем символ новой строки
                select_by_city(db, input);
                break;
                
            case 6: // Удаление записи по ID
                printf("\n--- Удаление записи по ID ---\n");
                printf("Введите ID для удаления: ");
                scanf("%d", &id);
                getchar(); // Очищаем символ новой строки
                delete_by_id(db, id);
                break;
                
            case 7: // Сохранение фото в файл
                printf("\n--- Сохранение фото в файл ---\n");
                printf("Введите ID владельца: ");
                scanf("%d", &id);
                getchar(); // Очищаем символ новой строки
                extract_photo_to_file(db, id, "data/photo_output.jpg");
                break;
                
            case 8: // Добавление владельца с фото
                printf("\n--- Добавление владельца с фото ---\n");
                printf("Введите путь к файлу с фотографией: ");
                scanf("%s", input);
                getchar(); // Очищаем символ новой строки
                insert_with_photo(db, input);
                break;
                
            case 0: // Выход из программы
                printf("\nЗавершение работы программы.\n");
                close_db(db);
                return 0;
                
            default: // Неверный выбор
                printf("\nНеверный выбор. Пожалуйста, выберите пункт из меню.\n");
        }
    }

    // Закрываем соединение с базой данных

    close_db(db);
    return 0;
}
